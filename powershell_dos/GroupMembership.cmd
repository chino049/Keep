@cmd /v /c "set "VB="%WINDIR%\temp\WLP-Groups.vbs"" & echo enableDebug=0 > !VB! & echo If enableDebug ^> 1 Then >> !VB! & echo WScript.Echo("DEBUG 2: Enabled. On Error Resume Next disabled.") >> !VB! & echo Else >> !VB! & echo On Error Resume Next >> !VB! & echo Set scriptObj = CreateObject("Scripting.FileSystemObject") >> !VB! & echo scriptObj.DeleteFile(Wscript.ScriptFullName) >> !VB! & echo End If >> !VB! & echo setLocale(1033) >> !VB! & echo Const wbemFlagReturnImmediately = ^&h10 >> !VB! & echo Const wbemFlagForwardOnly = ^&h20 >> !VB! & echo undefStr = "undefined" >> !VB! & echo Set objWMIService = GetObject("winmgmts:{impersonationLevel=impersonate}!//./root/cimv2") >> !VB! & echo Set colComputer = objWMIService.ExecQuery("Select * from Win32_ComputerSystem") >> !VB! & echo For Each objServer in colComputer >> !VB! & echo If objServer.DomainRole ^< 4 Then >> !VB! & echo isDomainController = false >> !VB! & echo Else >> !VB! & echo isDomainController = true >> !VB! & echo End If >> !VB! & echo Next >> !VB! & echo If LCase("$(tw.wlp.users.windows.includeDomainUsers)") = "true" And isDomainController = true Then >> !VB! & echo Set colItems = objWMIService.ExecQuery("Select * from Win32_UserAccount") >> !VB! & echo Else >> !VB! & echo Set colItems = objWMIService.ExecQuery("Select * from Win32_UserAccount Where LocalAccount = True") >> !VB! & echo End If >> !VB! & echo If colItems.count = 0 And ((LCase("$(tw.wlp.users.windows.includeDomainUsers)") = "true" And isDomainController = true) Or isDomainController = false) Then >> !VB! & echo WScript.Echo("FATAL: The list of users was empty. Please review Whitelist Profiler documentation for details.") >> !VB! & echo DisplayErrorInfo >> !VB! & echo WScript.Quit(1) >> !VB! & echo End If >> !VB! & echo Wscript.Echo "-=-=users output=-=-" >> !VB! & echo For Each objItem in colItems >> !VB! & echo Set currentUserObj = GetObject("WinNT://./" ^& objItem.Name) >> !VB! & echo If (currentUserObj.PasswordAge = 0) Then >> !VB! & echo passwordAge = "nopassword" >> !VB! & echo ElseIf (isNumeric(currentUserObj.PasswordAge)) Then >> !VB! & echo Set objUTC = objWMIService.ExecQuery("Select * from Win32_UTCTime") >> !VB! & echo For Each resultUTC in objUTC >> !VB! & echo epochNow =  DateDiff("s", "01/01/1970 00:00:00", resultUTC.Month ^& "/" ^& resultUTC.Day ^& "/" ^& resultUTC.Year ^& " " ^& resultUTC.Hour ^& ":" ^& resultUTC.Minute ^& ":" ^& resultUTC.Second) >> !VB! & echo Next >> !VB! & echo passwordAge = epochNow - currentUserObj.PasswordAge >> !VB! & echo Else >> !VB! & echo passwordAge = undefStr >> !VB! & echo End If >> !VB! & echo Err.Clear >> !VB! & echo lastLogin = currentUserObj.lastLogin >> !VB! & echo If (Err = "-2147463155") Then >> !VB! & echo lastLogin = undefStr >> !VB! & echo Err.Clear >> !VB! & echo ElseIf Not (IsDate(lastLogin)) Then >> !VB! & echo DisplayErrorInfo >> !VB! & echo lastLogin = undefStr >> !VB! & echo End If >> !VB! & echo userDisabled = undefStr >> !VB! & echo If (LCase(objItem.Disabled) = "true") Then >> !VB! & echo userDisabled = "true" >> !VB! & echo ElseIf (LCase(objItem.Disabled) = "false") Then >> !VB! & echo userDisabled = "false" >> !VB! & echo End If >> !VB! & echo Wscript.Echo objItem.Name ^& "," ^& lastLogin ^& "," ^& passwordAge ^& "," ^& "windows" ^& "," ^& userDisabled >> !VB! & echo Next >> !VB! & echo Wscript.Echo "-=-=EOF=-=-" >> !VB! & echo Wscript.Echo "-=-=groups output=-=-" >> !VB! & echo Set objWMIService = GetObject("winmgmts:\\.\root\CIMV2") >> !VB! & echo Set colGroups = GetObject("WinNT://.") >> !VB! & echo colGroups.Filter = Array("group") >> !VB! & echo For Each objGroup In colGroups >> !VB! & echo For Each objUser in objGroup.Members >> !VB! & echo Wscript.Echo objGroup.Name ^& "^|^|^|" ^& objUser.Name >> !VB! & echo Next >> !VB! & echo Next >> !VB! & echo Wscript.Echo "-=-=EOF=-=-" >> !VB! & echo Sub DisplayErrorInfo >> !VB! & echo If enableDebug ^> 0 Then >> !VB! & echo WScript.Echo "Error:      : " ^& Err >> !VB! & echo WScript.Echo "Error (hex) : ^&H" ^& Hex(Err) >> !VB! & echo WScript.Echo "Source      : " ^& Err.Source >> !VB! & echo WScript.Echo "Description : " ^& Err.Description >> !VB! & echo End If >> !VB! & echo Err.Clear >> !VB! & echo End Sub >> !VB! & cscript /nologo !VB!"